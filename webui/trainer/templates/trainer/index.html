<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Keyphrase Trainer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 2rem auto;
        max-width: 900px;
        color: #222;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      form {
        border: 1px solid #ddd;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
      }
      label {
        display: block;
        margin-top: 0.5rem;
      }
      input {
        width: 100%;
        padding: 0.4rem;
        margin-top: 0.25rem;
        box-sizing: border-box;
      }
      button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        vertical-align: top;
      }
      .status {
        font-weight: bold;
        text-transform: capitalize;
      }
      .log {
        font-family: monospace;
        white-space: pre-line;
        max-height: 120px;
        overflow: auto;
      }
      .progress-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .progress-item {
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #fafafa;
      }
      .progress-head {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        margin-bottom: 0.35rem;
        gap: 0.5rem;
      }
      .progress-bar {
        width: 100%;
        height: 10px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
        margin-bottom: 0.25rem;
      }
      .progress-bar-fill {
        height: 100%;
        background: #2563eb;
        transition: width 0.3s ease;
      }
      .progress-meta {
        font-size: 0.85rem;
        color: #4b5563;
      }
      .gen-summary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.75rem;
        font-size: 0.85rem;
      }
      .gen-summary-table th,
      .gen-summary-table td {
        padding: 0.35rem 0.4rem;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: top;
      }
      .gen-summary-table th {
        text-align: left;
        color: #374151;
        background: #fafafa;
        border-top: 1px solid #f0f0f0;
      }
    </style>
  </head>
  <body>
    <h1>Keyphrase Training</h1>
    <p>Generate audio data, train the model, and download the trained model's parameters once training is done.</p>

    <form method="post">
      {% csrf_token %}
      {{ form.non_field_errors }}
      {% for field in form %}
        <label for="{{ field.id_for_label }}">{{ field.label }}{% if field.field.required %}*{% endif %}</label>
        {{ field }}
        {% if field.errors %}
          <div style="color: red">
            {{ field.errors|striptags }}
          </div>
        {% endif %}
      {% endfor %}
      <button type="submit">Start Training Run</button>
    </form>

    <h2>Recent Runs</h2>
    <table>
      <thead>
        <tr>
          <th>Keyphrase</th>
          <th>Status</th>
          <th>Generation</th>
          <th>Metrics</th>
          <th>Logs</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody>
        {% for run in runs %}
          <tr>
            <td>{{ run.key_phrase }}</td>
            <td class="status" id="run-status-{{ run.id }}">{{ run.status }}</td>
            <td>
              <div
                id="run-generation-{{ run.id }}"
                data-run-id="{{ run.id }}"
                data-progress-url="{% url 'trainer:progress' run.id %}"
                data-initial-status="{{ run.status }}"
              >
              {% if run.generation_progress_items %}
                <div class="progress-list">
                  {% for info in run.generation_progress_items %}
                    <div class="progress-item">
                      <div class="progress-head">
                        <strong>{{ info.category_label }}</strong>
                        <span>
                          {{ info.completed_clips }}/{{ info.target_clips|default:info.generated_clips }}
                          clips ({{ info.requested_phrases }} phrases)
                        </span>
                      </div>
                      <div class="progress-bar">
                        <div
                          class="progress-bar-fill"
                          style="width: {{ info.completion_percent }}%;"
                        ></div>
                      </div>
                      <div class="progress-meta">
                        From DB: {{ info.db_clips_used }} · Generated: {{ info.generated_clips }}
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <table class="gen-summary-table">
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Target</th>
                      <th>Reused</th>
                      <th>Generated</th>
                      <th>Generated by</th>
                      <th>Reused from</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for info in run.generation_progress_items %}
                      <tr>
                        <td><strong>{{ info.category_label }}</strong></td>
                        <td>{{ info.target_clips }}</td>
                        <td>{{ info.db_clips_used }}</td>
                        <td>{{ info.generated_clips }}</td>
                        <td>
                          {% if info.generated_by_api %}
                            {% for api,count in info.generated_by_api.items %}
                              {{ api }}={{ count }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td>
                          {% if info.reused_by_api %}
                            {% for api,count in info.reused_by_api.items %}
                              {{ api }}={{ count }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                    <tr>
                      <td><strong>Total</strong></td>
                      <td><strong>{{ run.generation_progress_totals.target_clips }}</strong></td>
                      <td><strong>{{ run.generation_progress_totals.db_clips_used }}</strong></td>
                      <td><strong>{{ run.generation_progress_totals.generated_clips }}</strong></td>
                      <td>
                        {% if run.generation_progress_totals.generated_by_api %}
                          {% for api,count in run.generation_progress_totals.generated_by_api.items %}
                            {{ api }}={{ count }}{% if not forloop.last %}, {% endif %}
                          {% endfor %}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        {% if run.generation_progress_totals.reused_by_api %}
                          {% for api,count in run.generation_progress_totals.reused_by_api.items %}
                            {{ api }}={{ count }}{% if not forloop.last %}, {% endif %}
                          {% endfor %}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                    </tr>
                  </tbody>
                </table>
              {% else %}
                <em>Pending…</em>
              {% endif %}
              </div>
            </td>
            <td>
              {% if run.train_loss %}
                Train loss: {{ run.train_loss|floatformat:4 }}<br />
                Val loss: {{ run.val_loss|floatformat:4 }}<br />
                Macro F1: {{ run.macro_f1|floatformat:4 }}
              {% else %}
                —
              {% endif %}
            </td>
            <td class="log">
              {% if run.log %}
                {{ run.log }}
              {% else %}
                Awaiting updates…
              {% endif %}
            </td>
            <td>
              {% if run.is_download_ready %}
                <a id="run-download-{{ run.id }}" href="{% url 'trainer:download' run.id %}">Download Model</a>
              {% else %}
                <span id="run-download-{{ run.id }}">Not ready</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="6">No runs yet. Start one above!</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <script>
      (function () {
        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        }

        function fmtCounts(map) {
          if (!map) return "—";
          const entries = Object.entries(map);
          if (!entries.length) return "—";
          return entries.map(([k, v]) => `${escapeHtml(k)}=${escapeHtml(v)}`).join(", ");
        }

        function renderProgress(items, totals) {
          if (!items || !items.length) return "<em>Pending…</em>";
          const progressItemsHtml = items
            .map((info) => {
              const label = escapeHtml(info.category_label || info.category || "Category");
              const completed = Number(info.completed_clips || 0);
              const target = Number(info.target_clips || info.generated_clips || 0);
              const phrases = Number(info.requested_phrases || 0);
              const percent = Math.max(0, Math.min(100, Number(info.completion_percent || 0)));
              const dbUsed = Number(info.db_clips_used || 0);
              const gen = Number(info.generated_clips || 0);
              return `
                <div class="progress-item">
                  <div class="progress-head">
                    <strong>${label}</strong>
                    <span>${completed}/${target} clips (${phrases} phrases)</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: ${percent}%;"></div>
                  </div>
                  <div class="progress-meta">From DB: ${dbUsed} · Generated: ${gen}</div>
                </div>
              `;
            })
            .join("");

          const rowsHtml = items
            .map((info) => {
              return `
                <tr>
                  <td><strong>${escapeHtml(info.category_label || info.category || "")}</strong></td>
                  <td>${escapeHtml(info.target_clips ?? "")}</td>
                  <td>${escapeHtml(info.db_clips_used ?? "")}</td>
                  <td>${escapeHtml(info.generated_clips ?? "")}</td>
                  <td>${fmtCounts(info.generated_by_api)}</td>
                  <td>${fmtCounts(info.reused_by_api)}</td>
                </tr>
              `;
            })
            .join("");

          const totalRow = totals
            ? `
              <tr>
                <td><strong>Total</strong></td>
                <td><strong>${escapeHtml(totals.target_clips ?? "")}</strong></td>
                <td><strong>${escapeHtml(totals.db_clips_used ?? "")}</strong></td>
                <td><strong>${escapeHtml(totals.generated_clips ?? "")}</strong></td>
                <td>${fmtCounts(totals.generated_by_api)}</td>
                <td>${fmtCounts(totals.reused_by_api)}</td>
              </tr>
            `
            : "";

          return `
            <div class="progress-list">${progressItemsHtml}</div>
            <table class="gen-summary-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Target</th>
                  <th>Reused</th>
                  <th>Generated</th>
                  <th>Generated by</th>
                  <th>Reused from</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
                ${totalRow}
              </tbody>
            </table>
          `;
        }

        const POLL_MS = 1000;
        const nodes = Array.from(document.querySelectorAll("[data-progress-url]"));
        if (!nodes.length) return;

        const active = new Map();

        async function pollOne(node) {
          const url = node.getAttribute("data-progress-url");
          const runId = node.getAttribute("data-run-id");
          if (!url || !runId) return;
          try {
            const res = await fetch(url, { headers: { "X-Requested-With": "fetch" } });
            if (!res.ok) return;
            const data = await res.json();

            const statusEl = document.getElementById(`run-status-${runId}`);
            if (statusEl && data.status) statusEl.textContent = data.status;

            node.innerHTML = renderProgress(data.generation_progress_items, data.generation_progress_totals);

            const dlEl = document.getElementById(`run-download-${runId}`);
            if (dlEl) {
              if (data.is_download_ready && data.download_url) {
                dlEl.outerHTML = `<a id="run-download-${runId}" href="${escapeHtml(
                  data.download_url
                )}">Download Model</a>`;
              } else {
                if (dlEl.tagName && dlEl.tagName.toLowerCase() === "a") {
                  dlEl.outerHTML = `<span id="run-download-${runId}">Not ready</span>`;
                } else {
                  dlEl.textContent = "Not ready";
                }
              }
            }

            if (data.status === "completed" || data.status === "failed") {
              const timer = active.get(node);
              if (timer) clearInterval(timer);
              active.delete(node);
            }
          } catch (e) {
            // ignore transient errors
          }
        }

        for (const node of nodes) {
          const initialStatus = (node.getAttribute("data-initial-status") || "").toLowerCase();
          if (initialStatus === "completed" || initialStatus === "failed") continue;
          pollOne(node);
          const timer = setInterval(() => pollOne(node), POLL_MS);
          active.set(node, timer);
        }
      })();
    </script>
  </body>
</html>

